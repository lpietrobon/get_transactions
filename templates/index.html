<!DOCTYPE html>
<html>
<head>
<title>Plaid Link Example</title>
</head>
<body>
<button id="link-button">Link Bank Account</button>
<div id="token-display"></div>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
    let linkToken = null; // Variable to store link_token

    const linkHandler = Plaid.create({
        token: linkToken, // Use linkToken variable here
        onSuccess: async (public_token, metadata) => {
            console.log("Public token:", public_token);
            // Send public_token to your Python backend to exchange for access_token
            const response = await fetch('/exchange_public_token', { // Backend endpoint
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ public_token: public_token })
            });
            const data = await response.json();
            const accessToken = data.access_token;
            document.getElementById('token-display').innerText = "Access Token: " + accessToken;
            console.log("Access Token received in frontend:", accessToken);
            // Now you can use 'accessToken' in your Python app to fetch transactions
        },
        onExit: (exitError, metadata) => {
            console.log("Plaid Link Exit:", exitError, metadata);
        },
        onEvent: (eventName, metadata) => {
            console.log("Plaid Link Event:", eventName, metadata);
        },
        env: 'sandbox',
        product: ['transactions'],
        clientName: 'My Local Finance App',
        // publicKey: '{{ plaid_public_key }}', // Remove publicKey - using link_token now
    });

    document.getElementById('link-button').onclick = function() {
        linkHandler.open();
    };

    // **Fetch link_token from backend when page loads:**
    async function getLinkTokenFromServer() {
        const response = await fetch('/get_link_token', { method: 'POST' }); // Fetch from /get_link_token route
        const data = await response.json();
        linkToken = data.link_token; // Store link_token in the variable
        console.log("Link Token fetched from server:", linkToken);
        linkHandler.update({ token: linkToken }); // Update Plaid Link config with fetched token
    }

    getLinkTokenFromServer(); // Call function to fetch link_token on page load

</script>
</body>
</html>
